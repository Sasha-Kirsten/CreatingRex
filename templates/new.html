<!DOCTYPE html>
        <html>
        <head>
            <style>
                .container {
                    display: flex;
                    flex-wrap: nowrap;
                }
                .chatbot, .code-editor, .result-viewer {
                    flex: 1;
                    padding: 10px;
                    box-sizing: border-box;
                    height: 600px;
                    overflow-y: auto;
                }
                .chatbot {
                    background-color: #f0f0f0;
                }
                .code-editor {
                    background-color: #d0d0f0;
                }
                .result-viewer {
                    background-color: #b0b0f0;
                }
                .chat-message {
                    border-radius: 5px;
                    padding: 10px;
                    margin: 5px 0;
                    max-width: 80%;
                    word-wrap: break-word;
                    display: flex;
                    flex-wrap: wrap;
                }
                .user-message {
                    align-self: flex-end;
                    background-color: #4caf50;
                    color: white;
                    justify-content: flex-end;
                    margin-left: auto;
                    flex-direction: row-reverse;
                }
                .assistant-message {
                    align-self: flex-start;
                    background-color: #ddd;
                    justify-content: flex-start;
                    margin-right: auto;
                }
                .correct-answer {
                    color: green;
                    background-color: #FFFFFF;
                }

                .incorrect-answer {
                    color: red;
                    background-color: #FFFFFF;
                }
                .conversation-container {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    height: 500px; /* Adjust the height according to your need */
                    overflow-y: auto; /* Enables scrolling if content overflows */
                }
                .inputField {
                    align-self: flex-end;
                    margin-top: 10px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="chatbot">
                    <h2>Quiz Chatbot</h2>
                    <div id="subjectSelection">
                        Click on a subject to start the quiz:
                        <br/>
                        {% for subject in subjects %}
                        <button onclick="startQuiz('{{subject}}')">{{subject}}</button>
                        {% endfor %}
                    </div>
                    <img id="achievement-gif" src="" alt="Achievement" style="display: none;"> <!-- Image placeholder -->

                    <div id="moduleContainer" style="display: none;">
                        Click on a Module to start the quiz:
                        <br/>

                    </div>
                    <div id="subModuleContainer" style="display: none;">
                        Click on a Sub-Module to start the quiz:
                        <br/>
                    </div>
                    <div id="conversation" style="display: none;"></div>
                    <div class="inputField">
                        <input type="text" id="userInput" placeholder="Type your message here...">
                        <button id="send-button">Send</button>
                    </div>
                </div>
                <div class="code-editor">
                    <h2>Code Editor Section</h2>
                    <p>This section is for writing code.</p>
                </div>
                <div class="result-viewer">
                    <h2>Result Viewer Section</h2>
                    <p>This section is for viewing code results.</p>
                </div>
            </div>

            <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
            <script>
                const sendButton = document.getElementById('send-button');
                sendButton.addEventListener('click', userInput);
                let currentSubject = null;
                let currentQuestion = null;
                let userChoice = null;
                let conversationElement = document.getElementById('conversation');
                let currentModule = null;
                let currentSubModule = null;
                const correctMessages = [
                    "Great job! That's correct.",
                    "Awesome! You've got it right.",
                    "Excellent! Your answer is correct.",
                    "You nailed it! That's the correct answer.",
                    "Brilliant! You're doing well."
                ];

                const incorrectMessages = [
                    "No worries! You'll get the next one.",
                    "Don't give up! Let's try another question.",
                    "Keep going! You're learning.",
                    "That's okay! Remember, practice makes perfect.",
                    "It's alright! The correct answer is..."
                ];
                const nextQuestionPhrases = [
                    "Let's move on to the next question.",
                    "Are you ready for the next question?",
                    "Let's try another question now.",
                    "Ready for the next one?",
                    "Let's keep the momentum going with the next question."
                ];


                function startQuiz(subject) {
                    console.log(`startQuiz called with subject: ${subject}`);

                    // Fetch user status to see if the user is new or existing
                    fetch('/get_user_status?subject=' + subject, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.isNewUser) {
                            // Handle new user by starting from the first module and level
                            fetch('/get_first_module_and_level?subject=' + subject, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(firstModuleData => {
                                currentSubject = subject;
                                currentModule = firstModuleData.module;
                                currentLevel = firstModuleData.level;
                                startLevel(currentSubject, currentLevel, currentModule);
                            })
                            .catch(error => {
                                console.error('Error fetching first module and level:', error);
                            });
                        } else {
                            // Handle existing user by starting from the current level
                            currentLevel = data.level;
                            currentSubject = data.subject;
                            currentModule = data.module;
                            currentSubModule = data.subModule;
                            if (data.levelCompleted) {
                                generateQuestion(currentSubject,currentModule,currentSubModule);
                            } else {
                                generateQuestion(currentSubject, currentModule, currentSubModule);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
                function startLevel(subject, level, module) {
                    console.log(`Starting ${subject} at level ${level} and module ${module}`);

                    // Fetch the specific questions or content for this subject, level, and module
                    fetch(`/start_quiz?subject=${subject}&level=${level}&module=${module}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "Quiz started successfully") {
                            // Handle starting the quiz, such as by updating the UI to display the questions
                            // You can add your logic here, like initializing the quiz UI with the questions from the response
                        } else {
                            console.error('Error starting the quiz:', data.status);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }


                function startNextLevel(currentSubject, currentLevel, currentModule) {
                    currentLevel++; // Assuming currentLevel is defined and managed elsewhere in your code
                    startLevel(currentSubject, currentLevel, currentModule);
                }

                function startSubModuleSelection(module) {
                    // Fetch the submodules for the given module
                    fetch('/get_submodules?subject=' + encodeURIComponent(currentSubject) + '&module=' + encodeURIComponent(currentModule), {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP error ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const moduleContainer = document.getElementById('moduleContainer');
                        const subModuleContainer = document.getElementById('subModuleContainer');
                        moduleContainer.style.display = 'none';
                        subModuleContainer.style.display = 'block';
                        // Populate the subModuleContainer with options
                        subModuleContainer.innerHTML = ""; // Clear previous buttons
                        for (let submodule of data.submodules) {
                            let button = document.createElement('button');
                            button.value = submodule;
                            button.innerHTML = submodule;
                            button.onclick = function() {
                                // When a submodule button is clicked, start the quiz with the selected submodule
                                let selectedSubModule = this.value;
                                currentSubModule = selectedSubModule;

                                fetch('/start_quiz', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ subject: currentSubject, module: currentModule, submodule: selectedSubModule })
                                }).then(response => {
                                    if (response.ok) {
                                        subModuleContainer.style.display = 'none';
                                        generateQuestion(selectedSubModule);
                                        const inputField = document.getElementById('inputField');
                                        inputField.style.display = 'block';
                                    } else {
                                        console.error('Error starting quiz', response.statusText);
                                    }
                                }).catch(error => {
                                    console.error('Error:', error);
                                });
                            };
                            subModuleContainer.appendChild(button);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }

                async function generateQuestion() {
                    try {
                        const response = await fetch(`/generate_question?subject=${encodeURIComponent(currentSubject)}&modules=${encodeURIComponent(currentModule)}&submodule=${encodeURIComponent(currentSubModule)}`);
                        const data = await response.json();

                        currentQuestion = data;

                        const subjectSelection = document.getElementById('subjectSelection');
                        subjectSelection.style.display = 'none';


                        const conversation = document.getElementById('conversation');
                        conversation.style.display = 'block';

                        const questionElement = document.createElement('div');
                        questionElement.classList.add('chat-message');
                        questionElement.classList.add('assistant-message');
                        questionElement.textContent = data.question;


                        conversationElement.appendChild(questionElement);
                        updateScroll();

                        data.options.forEach((option, index) => {
                            const optionElement = document.createElement('div');
                            optionElement.classList.add('chat-message');
                            optionElement.classList.add('assistant-message');
                            optionElement.textContent = option;
                            optionElement.style.cursor = 'pointer';
                            optionElement.onclick = function() {
                                userChoice = index;
                                optionElement.style.backgroundColor = '#d1e3ff';
                                optionElement.style.pointerEvents = 'none';
                                submitAnswer();
                            };
                            updateScroll();
                            conversationElement.appendChild(optionElement);
                            updateScroll();
                        });
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }

                 function submitAnswer() {
                    if (userChoice === null) {
                        alert('Please select an answer.');
                        return;
                    }
                    if (!window.correctAnswerStreak) {
                        window.correctAnswerStreak = 0;
                    }
                    const conversationElement = document.getElementById('conversation');

                    // Create a new chat message with the user's answer.
                    const answerElement = document.createElement('div');
                    answerElement.classList.add('chat-message');
                    answerElement.classList.add('user-message');
                    answerElement.textContent = currentQuestion.options[userChoice];
                    updateScroll();
                    conversationElement.appendChild(answerElement);

                    fetch('/check_answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            subject: currentSubject,
                            user_choice: userChoice, // use userChoice here
                            question: currentQuestion.question,
                            modules: currentModule,
                            submodule: currentSubModule
                        })
                    }).then(response => response.json()).then(data => {
                        // Create a new chat message with whether the answer is correct.
                        const isCorrectElement = document.createElement('div');
                        isCorrectElement.classList.add('chat-message');
                        isCorrectElement.classList.add('assistant-message');
                        let message;
                        if (data.is_correct) {
                            window.correctAnswerStreak += 1;
                            const randomIndex = Math.floor(Math.random() * correctMessages.length);
                            message = correctMessages[randomIndex];
                           // isCorrectElement.textContent = message;
                            typeWriter(message,isCorrectElement);
                          //  speak(message);
                            isCorrectElement.classList.add('correct-answer');
                            conversationElement.appendChild(isCorrectElement);
                             if (data.explanation) {
                                const explanationElement = document.createElement('div');
                                explanationElement.classList.add('chat-message');
                                explanationElement.classList.add('assistant-message');
                             //   speak(data.explanation);
                                conversationElement.appendChild(explanationElement);
                                typeWriter('Explanation: ' + data.explanation, explanationElement);
                            }
                            askForMoreExplanation(data, conversationElement,1);
                            const achievementGif = document.getElementById("achievement-gif");
                            if (window.correctAnswerStreak === 3) {
                                achievementGif.src = "/static/three_in_a_row.gif";
                                achievementGif.style.display = "block";
                            } else if (window.correctAnswerStreak === 5) {
                                achievementGif.src = "/static/five_in_a_row.gif";
                                achievementGif.style.display = "block";
                            } else if (window.correctAnswerStreak === 10) {
                                if (user_data['incorrect_questions'].length == 0) { // Assuming you have access to user_data
                                    achievementGif.src = "/static/level_completed.gif";
                                    achievementGif.style.display = "block";
                                    // Logic to handle next level question or asking user if they want to continue
                                }
                            }
                        } else {
                            window.correctAnswerStreak = 0;
                            const randomIndex = Math.floor(Math.random() * incorrectMessages.length);
                            message = incorrectMessages[randomIndex] + ' The correct answer is: ' + data.correctAnswer;
                            isCorrectElement.textContent = message;
                          //  speak(message);
                            isCorrectElement.classList.add('incorrect-answer');
                            conversationElement.appendChild(isCorrectElement);

                            // Create a new chat message with the explanation if the answer is incorrect.
                            if (data.explanation) {
                                handleExplanation(data,conversationElement);
                            }
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                    });
                }
                 function askForMoreExplanation(data, conversationElement, tryCount) {
                    if (tryCount < 3) {
                        const nextQuestionElement = document.createElement('div');
                        nextQuestionElement.classList.add('chat-message');
                        nextQuestionElement.classList.add('assistant-message');
                        nextQuestionElement.style.fontWeight = 'bold';
                        typeWriter('Before moving to next question, Do you need more explanation?', nextQuestionElement);
                        conversationElement.appendChild(nextQuestionElement);

                        const yesButtonElement = document.createElement('button');
                        yesButtonElement.textContent = 'Yes';
                        yesButtonElement.onclick = function() {
                            const explanationElement = document.createElement('div');
                            explanationElement.classList.add('chat-message');
                            explanationElement.classList.add('assistant-message');
                            conversationElement.appendChild(explanationElement);

                            let explanationText;
                            if (tryCount === 1) explanationText = data.longexplanation;
                            else if (tryCount === 2) explanationText = data.alternateExplanation;

                            typeWriter('Explanation: ' + explanationText, explanationElement);
                            askForMoreExplanation(data, conversationElement, tryCount + 1);
                        };
                        conversationElement.appendChild(yesButtonElement);

                        const noButtonElement = document.createElement('button');
                        noButtonElement.textContent = 'No';
                        noButtonElement.onclick = function() {
                            handleUserChoice('got it');
                        };
                        conversationElement.appendChild(noButtonElement);
                    } else {
                        const instructionElement = document.createElement('div');
                        instructionElement.classList.add('chat-message');
                        instructionElement.classList.add('assistant-message');
                        instructionElement.textContent = 'Please enter your specific question in the input field below.';
                        conversationElement.appendChild(instructionElement);

                        const sendButton = document.getElementById('send-button');
                        sendButton.onclick = function() {
                            userInput();
                            // Wait a little bit to allow the user input to be processed, then ask again if they need more explanation
                            setTimeout(function() {
                                askForMoreExplanation(data, conversationElement, 3);
                            }, 1000);
                        };
                    }
                }

                function nextQuestion() {
                    userChoice = null;

                    // Instead of clearing the entire chat, just add a horizontal line to indicate a new question.
                    const conversationElement = document.getElementById('conversation');
                    const horizontalRule = document.createElement('hr');
                    conversationElement.appendChild(horizontalRule);

                    generateQuestion();
                    updateScroll();
                }
                function speak(text) {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = 0.9; // Change this value to adjust the speed of speech
                        window.speechSynthesis.speak(utterance);
                    }

                }
                function userInput() {
                    const userInput = document.getElementById('userInput').value;
                    const conversationElement = document.getElementById('conversation');

                    const userInputElement = document.createElement('div');
                    userInputElement.classList.add('chat-message');
                    userInputElement.classList.add('user-message');
                    userInputElement.textContent = userInput;
                    conversationElement.appendChild(userInputElement);

                    fetch('/user_input', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                             subject: currentSubject,
                            userInput: userInput
                        })
                    }).then(response => response.json()).then(data => {
                        const botResponseElement = document.createElement('div');
                        botResponseElement.classList.add('chat-message');
                        botResponseElement.classList.add('assistant-message');
                        botResponseElement.textContent = data.botResponse;
                    //botResponseElement.innerHTML = `<pre>${data.botResponse}</pre>`; // Apply formatting using the <pre> tag
                        conversationElement.appendChild(botResponseElement);

                    }).catch(error => {
                        console.error('Error:', error);
                    });
                }
                async function handleUserChoice(choice) {
                    switch(choice) {
                        case 'got it':
                            const followUpElement = document.createElement('div');
                            followUpElement.classList.add('chat-message');
                            followUpElement.classList.add('assistant-message');
                            const nextQuestionPhrase = nextQuestionPhrases[Math.floor(Math.random() * nextQuestionPhrases.length)];
                            typeWriter(nextQuestionPhrase, followUpElement);
                         //   speak(nextQuestionPhrase);
                            updateScroll();
                            conversationElement.appendChild(followUpElement);
                            setTimeout(nextQuestion, 2000);

                            break;
                        case 'more examples':
                            requestMoreExamples();
                            break;
                        case 'elaborate':
                            requestElaboration();
                            break;
                        default:
                            console.error('Unknown choice:', choice);
                    }
                }

                async function handleExplanation(data, conversationElement) {
                    const explanationElement = document.createElement('div');
                    explanationElement.classList.add('chat-message');
                    explanationElement.classList.add('assistant-message');
                 //   speak(data.explanation);
                    conversationElement.appendChild(explanationElement);
                    await typeWriter('Explanation: ' + data.explanation, explanationElement);
                    // Automatically go to the next question after 2 seconds
                  //  setTimeout(nextQuestion, 2000);
                // Provide user with options after incorrect explanation
                    const userOptionsElement = document.createElement('div');
                    userOptionsElement.classList.add('chat-message');
                    userOptionsElement.classList.add('assistant-message');
                    userOptionsElement.style.fontWeight = 'bold';
                    userOptionsElement.textContent = 'What would you like to do next?';
                    conversationElement.appendChild(userOptionsElement);
                    const gotItButtonElement = document.createElement('div');
                    gotItButtonElement.textContent = 'Got it';
                    gotItButtonElement.classList.add('chat-message');
                    gotItButtonElement.classList.add('user-message');
                    gotItButtonElement.style.cursor = 'pointer';
                    gotItButtonElement.onclick = function() {
                        gotItButtonElement.style.pointerEvents = 'none';
                        handleUserChoice('got it');
                    };
                    conversationElement.appendChild(gotItButtonElement);
                    const moreExamplesButtonElement = document.createElement('div');
                    moreExamplesButtonElement.textContent = 'More Examples';
                    moreExamplesButtonElement.classList.add('chat-message');
                    moreExamplesButtonElement.classList.add('user-message');
                    moreExamplesButtonElement.style.cursor = 'pointer';
                    moreExamplesButtonElement.onclick = function() {
                        moreExamplesButtonElement.style.pointerEvents = 'none';
                        handleUserChoice('more examples');
                    };
                    conversationElement.appendChild(moreExamplesButtonElement);
                    const elaborateButtonElement = document.createElement('div');
                    elaborateButtonElement.textContent = 'No, Please Elaborate';
                    elaborateButtonElement.classList.add('chat-message');
                    elaborateButtonElement.classList.add('user-message');
                    elaborateButtonElement.style.cursor = 'pointer';
                    elaborateButtonElement.onclick = function() {
                        elaborateButtonElement.style.pointerEvents = 'none';
                        handleUserChoice('elaborate');
                    };
                    updateScroll();
                    conversationElement.appendChild(elaborateButtonElement);

                }

                function typeWriter(text, element, delay = 10) {
                    return new Promise((resolve, reject) => {
                        let i = 0;
                        const timer = setInterval(function() {
                            if (i < text.length) {
                                element.textContent += text.charAt(i);

                                i++;
                                updateScroll();
                            } else {
                                clearInterval(timer);
                                resolve(); // resolve the promise when typing animation is done
                            }
                        }, delay);
                    });
                }
                function updateScroll() {
                    setTimeout(() => {
                        const chatBox = document.getElementById('conversation');
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }, 100);  // adjust the delay as needed
                }
            </script>
        </body>
        </html>